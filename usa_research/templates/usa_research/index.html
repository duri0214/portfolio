{% extends "usa_research/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2>ã‚¹ãƒˆãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚ºãƒ»ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>

    <!-- 0. ä¸»è¦ãƒã‚¯ãƒ­æŒ‡æ¨™ -->
    <section class="mb-5 border p-4 rounded shadow-sm bg-white">
        <div class="mb-4">
            <h4 class="text-primary mb-3"><i class="fas fa-globe-americas"></i> 0. ä¸»è¦ãƒã‚¯ãƒ­æŒ‡æ¨™</h4>
            <p class="text-muted"><i class="fas fa-clock"></i> æ—¥æ¬¡æ›´æ–° (Yahoo Finance çµŒç”±)</p>
        </div>
        <div class="card mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ISM è£½é€ æ¥­æ™¯æ°—æŒ‡æ•°</th>
                                <th>ç±³å›½10å¹´å‚µåˆ©å›ã‚Š</th>
                                <th>VIX æŒ‡æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for indicator in macro_indicators %}
                            <tr>
                                <td>{{ indicator.date|date:"Y/m/d" }}</td>
                                <td>{{ indicator.ism_pmi|default_if_none:"-" }}</td>
                                <td>{{ indicator.us_10y_yield|floatformat:3|default_if_none:"-" }}%</td>
                                <td>{{ indicator.vix|floatformat:2|default_if_none:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="p-4 text-muted">
                                    ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`python manage.py update_macro_indicators` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mt-2 text-muted small">
            <h6>ç”¨èªè§£èª¬ãƒ»è¨ˆç®—ãƒ«ãƒ¼ãƒ«:</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="mb-0">
                        <li>
                            <a href="https://finance.yahoo.com/quote/NAPM" target="_blank" rel="noopener noreferrer" class="text-dark">
                                <strong>ISM è£½é€ æ¥­æ™¯æ°—æŒ‡æ•°</strong> <i class="fas fa-external-link-alt small"></i>
                            </a>: è£½é€ æ¥­ã®è³¼è²·æ‹…å½“ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¸ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèª¿æŸ»ã«åŸºã¥ãæ™¯æ³æ„ŸæŒ‡æ•°ã€‚50ã‚’ä¸Šå›ã‚‹ã¨æ™¯æ°—æ‹¡å¤§ã€ä¸‹å›ã‚‹ã¨æ™¯æ°—å¾Œé€€ã®ç›®å®‰ã€‚
                        </li>
                        <li>
                            <a href="https://finance.yahoo.com/quote/%5ETNX" target="_blank" rel="noopener noreferrer" class="text-dark">
                                <strong>ç±³å›½10å¹´å‚µåˆ©å›ã‚Š</strong> <i class="fas fa-external-link-alt small"></i>
                            </a>: ç±³å›½æ”¿åºœãŒç™ºè¡Œã™ã‚‹å„Ÿé‚„æœŸé–“10å¹´ã®å›½å‚µï¼ˆ10-Year Treasury Noteï¼‰ã®åˆ©å›ã‚Šã€‚é•·æœŸé‡‘åˆ©ã®ä»£è¡¨çš„ãªæŒ‡æ¨™ã€‚
                        </li>
                    </ul>
                </div>
                <div class="col-md-6 border-left">
                    <ul class="mb-0">
                        <li>
                            <a href="https://finance.yahoo.com/quote/%5EVIX" target="_blank" rel="noopener noreferrer" class="text-dark">
                                <strong>VIX æŒ‡æ•°</strong> <i class="fas fa-external-link-alt small"></i>
                            </a>: ã‚·ã‚«ã‚´ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¼•æ‰€ï¼ˆCBOEï¼‰ãŒç®—å‡ºã™ã‚‹ã€Œãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã€‚å¸‚å ´ãŒäºˆæƒ³ã™ã‚‹å°†æ¥ã®å¤‰å‹•ç‡ã‚’ç¤ºã—ã€ã€Œææ€–æŒ‡æ•°ã€ã¨ã‚‚å‘¼ã°ã‚Œã‚‹ã€‚
                        </li>
                    </ul>
                </div>
                <div class="col-md-12 mt-3 border-top pt-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-lightbulb text-warning"></i> ãƒã‚¯ãƒ­æŒ‡æ¨™ã®æ ¼è¨€:</h6>
                        <small class="text-muted">
                            å‡ºå…¸: <a href="https://note.com/gityamatome/n/nc51b4ae65409" target="_blank" rel="noopener noreferrer">gityamatome (note) <i class="fas fa-external-link-alt"></i></a>
                        </small>
                    </div>
                    <ul class="mb-0">
                        <li>é•·æœŸé‡‘åˆ©ãŒä¸‹è½ã™ã‚‹ã¨æ ªä¾¡ã¯ä¸ŠãŒã‚Šã‚„ã™ããªã‚Šã¾ã™ï¼ˆğŸ‘´ã€Œæ ªã¯é•·æœŸé‡‘åˆ©ã§70ï¼…ã€æ¥­ç¸¾ã§30ï¼…æ±ºã¾ã‚‹ã€ï¼‰</li>
                        <li>
                            <strong>ç›¸å ´ãŒåº•å…¥ã‚Œã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³:</strong>
                            <ol class="mb-0">
                                <li>å‚µåˆ¸åˆ©å›ã‚ŠãŒä¸‹ãŒã‚‹</li>
                                <li>VIXãŒéå¸¸ã«é«˜ããªã£ãŸå¾Œã§ã€ã‚†ã£ãã‚Šä¸‹ãŒã‚Šå§‹ã‚ã‚‹</li>
                            </ol>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- 1. è³‡ç”£ã‚¯ãƒ©ã‚¹åˆ¥ãƒ»é•·æœŸãƒªã‚¿ãƒ¼ãƒ³æ¨ç§» (Quantitative Evidence) -->
    <section class="mb-5 border p-4 rounded shadow-sm bg-white">
        <div class="mb-4">
            <h4 class="text-primary mb-3"><i class="fas fa-chart-area"></i> 1. è³‡ç”£ã‚¯ãƒ©ã‚¹åˆ¥ãƒ»é•·æœŸãƒªã‚¿ãƒ¼ãƒ³æ¨ç§»</h4>
            <p class="text-muted">ã€Œãªãœæ ªï¼ˆStocksï¼‰ã¯é•·æœŸã§è¦‹ã‚Œã°ä¾¡å€¤ãŒä¸ŠãŒã‚Šç¶šã‘ã¦ããŸã®ã‹ã€ã‚’ãƒ‡ãƒ¼ã‚¿ã§è£ä»˜ã‘ã‚‹</p>
        </div>

        <div class="mb-4" style="height: 400px;">
            <canvas id="assetReturnsChart"></canvas>
        </div>

        <div class="mt-2 text-muted small">
            <h6>ãªãœ SPY (S&P 500) ã‚’æ ªå¼ã®ä»£è¡¨æŒ‡æ¨™ã¨ã™ã‚‹ã®ã‹:</h6>
            <div class="row">
                <div class="col-md-12">
                    <p class="mb-2">
                        æœ¬ãƒ‡ãƒ¼ã‚¿ã§ã¯ã€æ ªå¼ã®ä»£è¡¨ã¨ã—ã¦ <strong>SPY (S&P 500 ETF)</strong> ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯å˜ãªã‚‹ã€Œæˆé•·æ ªã®å¯„ã›é›†ã‚ã€ã§ã¯ãªãã€ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰ <strong>ã€Œç±³å›½çµŒæ¸ˆãã®ã‚‚ã®ã¸ã®æŠ•è³‡çµæœã€</strong> ã‚’ç¤ºã™ã®ã«æœ€ã‚‚é©ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
                    </p>
                    <ul>
                        <li><strong>åºƒç¯„ãªç¶²ç¾…æ€§:</strong> ç±³å›½ã®ä¸»è¦ç”£æ¥­ã‚’ç¶²ç¾…ã™ã‚‹å¤§å‹ä¼æ¥­500ç¤¾ã§æ§‹æˆã•ã‚Œã€ç‰¹å®šã®ã‚»ã‚¯ã‚¿ãƒ¼ã«åã‚‰ãšç±³å›½çµŒæ¸ˆå…¨ä½“ã‚’åæ˜ ã—ã¾ã™ã€‚</li>
                        <li><strong>ä»£è¬ï¼ˆã‚µãƒã‚¤ãƒãƒ«ï¼‰æ©Ÿèƒ½:</strong> æ§‹æˆéŠ˜æŸ„ã¯å›ºå®šã§ã¯ãªãã€æ™‚ä»£ã®å¤‰åŒ–ã«åˆã‚ã›ã¦å¸¸ã«æ–°é™³ä»£è¬ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Œæ ªä¾¡æŒ‡æ•°ã€ã¯é•·æœŸçš„ã«ã€Œç”Ÿãæ®‹ã£ãŸå¼·è€…ã®é›†åˆä½“ã€ã§ã‚ã‚Šç¶šã‘ã¾ã™ã€‚</li>
                        <li><strong>é…å½“å†æŠ•è³‡ã®è¦–ç‚¹:</strong> å€‹åˆ¥æ ªã®ã‚ˆã†ãªå€’ç”£ãƒªã‚¹ã‚¯ã‚„ã€NASDAQã®ã‚ˆã†ãªæ¥µç«¯ãªãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æŠ‘ãˆã¤ã¤ã€çµŒæ¸ˆæˆé•·ã®æœå®Ÿã‚’æœ€ã‚‚åŠ¹ç‡çš„ã«äº«å—ã§ãã‚‹æŒ‡æ¨™ã§ã™ã€‚</li>
                    </ul>
                    <p class="mb-0">
                        ã€Œæ ªã¯çŸ­æœŸã§ã¯ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã®ã‚ˆã†ã«ä¸Šä¸‹ã™ã‚‹ãŒã€é•·æœŸï¼ˆæ•°åå¹´å˜ä½ï¼‰ã§ã¯çµŒæ¸ˆæˆé•·ã¨ä¼æ¥­ã®åˆ©ç›Šæˆé•·ã‚’ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«åæ˜ ã—ã€ä»–ã®è³‡ç”£ã‚¯ãƒ©ã‚¹ã‚’å‡Œé§•ã—ã¦ããŸã€ã¨ã„ã†äº‹å®Ÿã‚’ã€ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ç¤ºã—ã¦ã„ã¾ã™ã€‚
                    </p>
                    <p class="mt-2 text-info">
                        â€» ã‚°ãƒ©ãƒ•ã¯å„è³‡ç”£ã®ä¾¡æ ¼ã‚’ã€å–å¾—é–‹å§‹æ™‚ç‚¹ã‚’100ã¨ã—ã¦æŒ‡æ•°åŒ–ã—ãŸã‚‚ã®ã§ã™ï¼ˆç´¯ç©ãƒªã‚¿ãƒ¼ãƒ³ã®æ¯”è¼ƒï¼‰ã€‚<br>
                        â€» SPY, TLT ãªã©ã® ETF ã¯ãƒˆãƒ¼ã‚¿ãƒ«ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆé…å½“è¾¼ã¿ï¼‰ã§ã™ãŒã€^GSPC, ^TYX, DX-Y.NYB ãªã©ã®æŒ‡æ•°ï¼ˆIndexï¼‰ã¯ä¾¡æ ¼ã®ã¿ã‚’åæ˜ ã—ã¦ãŠã‚Šã€é…å½“ã‚’å«ã¿ã¾ã›ã‚“ã€‚1950å¹´ä»£ã‹ã‚‰ã®è¶…é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç¢ºèªã™ã‚‹éš›ã¯æŒ‡æ•°ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
            </div>
        </div>
    </section>

    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const rawData = [
                {% for p in asset_prices %}
                { date: "{{ p.date|date:'Y-m-d' }}", symbol: "{{ p.symbol }}", price: {{ p.price }} },
                {% endfor %}
            ];

            if (rawData.length === 0) return;

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
            const symbols = [...new Set(rawData.map(d => d.symbol))];
            const dates = [...new Set(rawData.map(d => d.date))].sort();

            // æ¤œç´¢ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—åŒ–ã™ã‚‹
            // dataMap[date][symbol] = price
            const dataMap = {};
            rawData.forEach(d => {
                if (!dataMap[d.date]) dataMap[d.date] = {};
                dataMap[d.date][d.symbol] = d.price;
            });

            // å„ã‚·ãƒ³ãƒœãƒ«ã®åˆæœŸå€¤ã‚’100ã¨ã—ã¦æ­£è¦åŒ–
            const firstPrices = {};
            symbols.forEach(s => {
                // æœ€åˆã®æœ‰åŠ¹ãªä¾¡æ ¼ã‚’æ¢ã™
                for (const d of dates) {
                    if (dataMap[d] && dataMap[d][s]) {
                        firstPrices[s] = dataMap[d][s];
                        break;
                    }
                }
            });

            const datasets = symbols.map(s => {
                const symbolData = dates.map(d => {
                    const price = dataMap[d] ? dataMap[d][s] : null;
                    if (price && firstPrices[s]) {
                        return (price / firstPrices[s] * 100).toFixed(2);
                    }
                    return null;
                });

            const colors = {
                'SPY': 'rgba(255, 99, 132, 1)',
                '^GSPC': 'rgba(255, 99, 132, 0.5)',
                'TLT': 'rgba(54, 162, 235, 1)',
                '^TYX': 'rgba(54, 162, 235, 0.5)',
                'BIL': 'rgba(75, 192, 192, 1)',
                'GLD': 'rgba(255, 206, 86, 1)',
                'GC=F': 'rgba(255, 206, 86, 0.5)',
                'UUP': 'rgba(153, 102, 255, 1)',
                'DX-Y.NYB': 'rgba(153, 102, 255, 0.5)'
            };

                return {
                    label: s,
                    data: symbolData,
                    borderColor: colors[s] || 'rgba(200, 200, 200, 1)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                };
            });

            const ctx = document.getElementById('assetReturnsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Date' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Index (Start = 100)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
    {% endblock %}

    <!-- 2. MSCIãƒ¬ãƒãƒ¼ãƒˆã®è¦ç´„ -->
    <section class="mb-5 border p-4 rounded shadow-sm bg-light">
        <div class="mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h4 class="text-primary mb-1"><i class="fas fa-chart-pie"></i> 2. MSCIãƒ¬ãƒãƒ¼ãƒˆã®è¦ç´„</h4>
                {% if msci_report %}
                <p class="text-muted mb-0 small"><i class="fas fa-calendar-alt"></i> Report Date: {{ msci_report.report_date|date:"Y/m/d" }}</p>
                {% endif %}
            </div>
            {% if msci_report %}
            <a href="{{ msci_report.pdf_url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-file-pdf"></i> Original PDF
            </a>
            {% endif %}
        </div>
        <div class="bg-white p-3 border rounded">
            {% if msci_report %}
                {{ msci_report.summary_html|safe }}
            {% else %}
                <p class="text-muted mb-0">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`python manage.py update_msci_weights` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            {% endif %}
        </div>
    </section>

    <!-- 3. ã‚¹ãƒˆãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚ºãƒ»ã‚¢ãƒ«ãƒãƒŠãƒƒã‚¯ -->
    <section class="mb-5 border p-4 rounded shadow-sm">
        <div class="mb-4">
            <h4 class="text-primary mb-3"><i class="fas fa-info-circle"></i> 3. ã‚¹ãƒˆãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚ºãƒ»ã‚¢ãƒ«ãƒãƒŠãƒƒã‚¯ ã‹ã‚‰</h4>
            <p class="text-muted">
                è©³ç´°ãªçµ±è¨ˆã‚„æœ€æ–°æƒ…å ±ã¯å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ï¼š
                <a href="https://www.stocktradersalmanac.com/" target="_blank" rel="noopener noreferrer">
                    Stock Trader's Almanac Official Site <i class="fas fa-external-link-alt"></i>
                </a>
            </p>
        </div>

        <!-- 3-1. å­£ç¯€ç³»ã‚¢ãƒãƒãƒªãƒ¼ï¼ˆTABLEè¡¨ç¤ºï¼‰ -->
        <h5 class="mb-3">3-1. å­£ç¯€ç³»ã‚¢ãƒãƒãƒªãƒ¼ï¼ˆTABLEè¡¨ç¤ºï¼‰</h5>
        <div class="card mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 100px;">æœˆ</th>
                                <th style="width: 200px;">ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th>æ¦‚è¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in monthly_anomalies %}
                            <tr {% if item.month == current_month %}class="table-warning font-weight-bold"{% endif %}>
                                <td>{{ item.month }}æœˆ</td>
                                <td>{{ item.title }}</td>
                                <td>{{ item.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3-2. æ¥­ç¨®ãƒ»ãƒ†ãƒ¼ãƒç³»ã‚¢ãƒãƒãƒªãƒ¼ï¼ˆCARDè¡¨ç¤ºï¼‰ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>3-2. æ¥­ç¨®ãƒ»ãƒ†ãƒ¼ãƒç³»ã‚¢ãƒãƒãƒªãƒ¼ï¼ˆCARDè¡¨ç¤ºï¼‰</h5>
            <button onclick="location.reload();" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-sync-alt"></i> ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            </button>
        </div>
        <div class="row">
            {% for item in theme_anomalies %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 shadow-sm border-info">
                    <div class="card-header bg-info text-white py-1">
                        <small>{{ item.category }}</small>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center text-center">
                        <p class="card-text mb-0">{{ item.content }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-4 text-muted small">
            <p>â€» ã‚¹ãƒˆãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚ºãƒ»ã‚¢ãƒ«ãƒãƒŠãƒƒã‚¯ã«åŸºã¥ãã‚¢ãƒãƒãƒªãƒ¼ã€‚æŠ•è³‡åˆ¤æ–­ã®æ€è€ƒè£œåŠ©ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
        </div>
    </section>

    <!-- 4. ã‚»ã‚¯ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆæ•°è¡¨ (GICS) -->
    <section class="mb-5 border p-4 rounded shadow-sm bg-light">
        <div class="mb-4">
            <h4 class="text-primary mb-3"><i class="fas fa-chart-line"></i> 4. ã‚»ã‚¯ã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆæ•°è¡¨ (GICS)</h4>
            <p class="text-muted">
                åŸºæº–æ—¥: {{ sector_latest_date|date:"Y/m/d" }} | 
                åˆ†é¡: <a href="https://www.msci.com/our-solutions/indexes/gics" target="_blank" rel="noopener noreferrer">GICS (11ã‚»ã‚¯ã‚¿ãƒ¼) <i class="fas fa-external-link-alt"></i></a> |
                ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯: 
                <a href="https://finance.yahoo.com/quote/SPY/" target="_blank" rel="noopener noreferrer">
                    SPY (S&P500) <i class="fas fa-external-link-alt"></i>
                </a> | <i class="fas fa-clock"></i> æ—¥æ¬¡æ›´æ–°
            </p>
        </div>

        <div class="card mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>Signal</th>
                                <th class="text-left">Sector</th>
                                <th>Symbol</th>
                                <th>Rank</th>
                                <th>Î”Rank(5d)</th>
                                <th>RS_20d(%)</th>
                                <th>Î”RS_5d(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for snapshot in sector_snapshots %}
                            <tr>
                                <td>
                                    {% if snapshot.signal == 'Green' %}
                                        <span class="badge badge-success" style="background-color: #28a745; color: white;">Green</span>
                                    {% elif snapshot.signal == 'Yellow' %}
                                        <span class="badge badge-warning" style="background-color: #ffc107; color: black;">Yellow</span>
                                    {% elif snapshot.signal == 'Red' %}
                                        <span class="badge badge-danger" style="background-color: #dc3545; color: white;">Red</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-left">
                                    {% if snapshot.sector.name == 'Information Technology' %}<i class="fas fa-laptop-code fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Financials' %}<i class="fas fa-university fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Health Care' %}<i class="fas fa-stethoscope fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Consumer Discretionary' %}<i class="fas fa-shopping-cart fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Consumer Staples' %}<i class="fas fa-apple-alt fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Energy' %}<i class="fas fa-fire fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Industrials' %}<i class="fas fa-industry fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Materials' %}<i class="fas fa-mountain fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Utilities' %}<i class="fas fa-bolt fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Real Estate' %}<i class="fas fa-building fa-fw text-muted mr-1"></i>
                                    {% elif snapshot.sector.name == 'Communication Services' %}<i class="fas fa-broadcast-tower fa-fw text-muted mr-1"></i>
                                    {% endif %}
                                    {{ snapshot.sector.name }}
                                </td>
                                <td><code class="text-primary">{{ snapshot.sector.symbol }}</code></td>
                                <td><strong>{{ snapshot.rank }}</strong></td>
                                <td>
                                    {% if snapshot.rank_delta_5d < 0 %}
                                        <span class="text-success"><i class="fas fa-caret-up"></i> {{ snapshot.rank_delta_5d|floatformat:0|cut:"-" }}</span>
                                    {% elif snapshot.rank_delta_5d > 0 %}
                                        <span class="text-danger"><i class="fas fa-caret-down"></i> {{ snapshot.rank_delta_5d|floatformat:0 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ snapshot.rs_20d|floatformat:2 }}%</td>
                                <td>
                                    {% if snapshot.rs_slope_5d > 0 %}
                                        <span class="text-success">+{{ snapshot.rs_slope_5d|floatformat:2 }}%</span>
                                    {% elif snapshot.rs_slope_5d < 0 %}
                                        <span class="text-danger">{{ snapshot.rs_slope_5d|floatformat:2 }}%</span>
                                    {% else %}
                                        {{ snapshot.rs_slope_5d|floatformat:2 }}%
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="p-4 text-muted">
                                    ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`python manage.py update_sector_rotation` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mt-2 text-muted small">
            <h6>ç”¨èªè§£èª¬ãƒ»è¨ˆç®—ãƒ«ãƒ¼ãƒ«:</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="mb-2">
                        <li><strong>RS_20d(%)</strong> (Relative Strength): ã‚»ã‚¯ã‚¿ãƒ¼ETFã®20æ—¥ãƒªã‚¿ãƒ¼ãƒ³ã¨SPY(S&P500)ã®20æ—¥ãƒªã‚¿ãƒ¼ãƒ³ã®å·®åˆ†ã€‚ãƒ—ãƒ©ã‚¹ãªã‚‰å¸‚å ´å¹³å‡ã‚ˆã‚Šå¼·ãã€ãƒã‚¤ãƒŠã‚¹ãªã‚‰å¼±ã„ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚</li>
                        <li><strong>Î”RS_5d(%)</strong>: RS_20dã®5å–¶æ¥­æ—¥å‰ã‹ã‚‰ã®å¤‰åŒ–å¹…ã€‚å‹¢ã„ï¼ˆãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ï¼‰ã®å¤‰åŒ–ã‚’è¨ˆã‚Šã¾ã™ã€‚</li>
                        <li><strong>Rank</strong>: RS_20dã«åŸºã¥ã11ã‚»ã‚¯ã‚¿ãƒ¼å†…ã®é †ä½ï¼ˆ1ä½ãŒæœ€å¼·ï¼‰ã€‚</li>
                        <li><strong>Î”Rank(5d)</strong>: 5å–¶æ¥­æ—¥å‰ã¨æ¯”è¼ƒã—ãŸé †ä½ã®å¤‰å‹•ã€‚æ•°å€¤ãŒãƒã‚¤ãƒŠã‚¹ï¼ˆä¾‹: -2ï¼‰ãªã‚‰é †ä½ãŒ2ã¤ä¸ŠãŒã£ãŸã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div class="col-md-6 border-left">
                    <p class="mb-1"><strong>ä¿¡å·æ©Ÿãƒ«ãƒ¼ãƒ«:</strong></p>
                    <ul class="mb-0">
                        <li><span class="badge badge-success" style="background-color: #28a745; color: white;">Green</span>: <strong>å‡ºé…ã‚Œã‹ã‚‰ã®åç™º</strong> (RS_20d < 0 ã‹ã¤ Î”RS_5d > 0 ã‹ã¤ Î”Rank_5d â‰¤ -2)</li>
                        <li><span class="badge badge-warning" style="background-color: #ffc107; color: black;">Yellow</span>: <strong>å‹¢ã„æ”¹å–„ä¸­</strong> (Î”RS_5d > 0)</li>
                        <li><span class="badge badge-danger" style="background-color: #dc3545; color: white;">Red</span>: <strong>éç†±ã‹ã‚‰ã®å¤±é€Ÿ</strong> (RS_20d > 0 ã‹ã¤ Î”RS_5d < 0 ã‹ã¤ Î”Rank_5d â‰¥ 2)</li>
                    </ul>
                </div>
                <div class="col-md-12 mt-3 border-top pt-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-sync"></i> æ™¯æ°—ã‚µã‚¤ã‚¯ãƒ«ã¨ã‚»ã‚¯ã‚¿ãƒ¼ã®ä¸€èˆ¬çš„æ³•å‰‡:</h6>
                        <small class="text-muted">
                            è§£èª¬ãƒ»è©³ç´°: 
                            <a href="https://www.investopedia.com/articles/trading/05/020305.asp" target="_blank" rel="noopener noreferrer">Investopedia <i class="fas fa-external-link-alt"></i></a>
                        </small>
                    </div>
                    <div class="row">
                        <div class="col-md-3 border-right">
                            <small class="font-weight-bold text-success">ã€æ‹¡å¤§æœŸã€‘æ™¯æ°—ï¼‹ / é‡‘åˆ©ãƒ¼</small><br>
                            <small>Information Technology, Financials</small>
                        </div>
                        <div class="col-md-3 border-right">
                            <small class="font-weight-bold text-primary">ã€æˆç†ŸæœŸã€‘æ™¯æ°—ï¼‹ / é‡‘åˆ©ï¼‹</small><br>
                            <small>Industrials, Materials, Consumer Discretionary</small>
                        </div>
                        <div class="col-md-3 border-right">
                            <small class="font-weight-bold text-danger">ã€å¾Œé€€æœŸã€‘æ™¯æ°—ãƒ¼ / é‡‘åˆ©ï¼‹</small><br>
                            <small>Energy</small>
                        </div>
                        <div class="col-md-3">
                            <small class="font-weight-bold text-secondary">ã€åœæ»æœŸã€‘æ™¯æ°—ãƒ¼ / é‡‘åˆ©ãƒ¼</small><br>
                            <small>Communication Services, Health Care, Consumer Staples, Utilities</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 5. RSS ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ -->
    <section class="mb-5 border p-4 rounded shadow-sm">
        <div class="mb-4">
            <h4 class="text-primary mb-3">
                <i class="fas fa-rss"></i> 5. RSS ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰
            </h4>
            <p class="text-muted">
                <i class="fas fa-clock"></i> æ—¥æ¬¡æ›´æ–°
            </p>
        </div>
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for feed in rss_feeds %}
                    <a href="{{ feed.link }}" target="_blank" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 text-primary">{{ feed.title }}</h6>
                            <small class="text-muted">{{ feed.published_at|date:"Y/m/d H:i" }}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-secondary">{{ feed.source.name }} - {{ feed.source.category }}</small>
                        </div>
                    </a>
                    {% empty %}
                    <div class="p-4 text-center text-muted">
                        è¡¨ç¤ºã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}
