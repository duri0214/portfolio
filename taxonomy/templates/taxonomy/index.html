{% extends "taxonomy/base.html" %}
{% load static %}
{% block content %}
    <div class="custom-section bg-light p-5 rounded">
        <h1 class="display-4">Let's analyze Taxonomy!</h1>
        <p class="lead">it's interesting Taxonomy</p>
        <hr class="my-4">
        <p>You can understand taxonomies</p>
        <ul class="list-items">
            <li><a class="btn btn-secondary btn-sm disabled" href="#" role="button">界(kingdom)のメンテナンス</a>
            </li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#"
                   role="button">門(phylum)のメンテナンス</a></li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#" role="button">綱(classification)のメンテナンス</a>
            </li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#"
                   role="button">科(family)のメンテナンス</a></li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#"
                   role="button">属(genus)のメンテナンス</a></li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#" role="button">種(species)のメンテナンス</a>
            </li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#"
                   role="button">品種(breed)のメンテナンス</a></li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#"
                   role="button">タグ(tag)のメンテナンス</a></li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#"
                   role="button">品種とタグの紐づけ</a></li>
            <li><a class="btn btn-secondary btn-sm disabled" href="#" role="button">関係図</a></li>
        </ul>
        <ul class="list-items">
            <li><a class="btn btn-outline-primary" href="#chicken-chart" role="button">鶏の観察グラフ</a></li>
        </ul>
    </div>
    <section id="chicken-chart" class="container">
        <h3>分類グラフ</h3>
        <div id="chart-area">
            <div class="text">See one-liners for each transition</div>
            <script>
                const dataSpec = {
                    source: JSON.parse('{{ data|safe }}'),
                    key: "name",
                };
                const myChart = d3.indentedTree(dataSpec);
                d3.select("#chart-area").append("div").attr("class", "chart").call(myChart);
            </script>
        </div>
    </section>
    <section id="feed-vs-egg-chart" class="container">
        <h3>餌の量と産卵率の推移</h3>
        <div id="chart-area"></div>
        <script>
            const feedVsEggData = {{ feed_vs_egg|safe }};

            // SVG領域の設定
            const margin = {top: 20, right: 60, bottom: 40, left: 50};
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#chart-area").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // X軸: 日付
            const x = d3.scaleTime()
                .domain(d3.extent(feedVsEggData, d => new Date(d.recorded_date)))
                .range([0, width]);
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            // Y軸: 餌投入量
            const yLeft = d3.scaleLinear()
                .domain([0, d3.max(feedVsEggData, d => d.total_feed)])
                .range([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(yLeft))
                .style("fill", "steelblue");

            // Y軸右: 卵の生産数
            const yRight = d3.scaleLinear()
                .domain([0, d3.max(feedVsEggData, d => d.total_eggs)])
                .range([height, 0]);
            svg.append("g")
                .attr("transform", `translate(${width}, 0)`)
                .call(d3.axisRight(yRight))
                .style("fill", "orange");

            // 餌投入量: 折れ線
            svg.append("path")
                .datum(feedVsEggData)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(d => x(new Date(d.recorded_date)))
                    .y(d => yLeft(d.total_feed))
                );

            // 卵生産数: オレンジの点プロット
            svg.selectAll(".dot")
                .data(feedVsEggData)
                .enter()
                .append("circle")
                .attr("cx", d => x(new Date(d.recorded_date)))
                .attr("cy", d => yRight(d.total_eggs))
                .attr("r", 4)
                .style("fill", "orange")
                .style("opacity", 0.8);

            // ラベル追加
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom)
                .attr("text-anchor", "middle")
                .text("日付");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 10)
                .attr("text-anchor", "middle")
                .style("fill", "steelblue")
                .text("餌投入量 (g)");

            svg.append("text")
                .attr("transform", `translate(${width + 50}, ${height / 2}) rotate(90)`)
                .attr("text-anchor", "middle")
                .style("fill", "orange")
                .text("卵 生産数");
        </script>
    </section>
{% endblock %}
