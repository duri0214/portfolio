{% extends "ai_agent/base.html" %}
{% load static %}

{% block content %}
    <div class="custom-section bg-light p-5 rounded">
        <h1 class="display-4">Hello, AI Agent!</h1>
        <p class="lead">It's an interesting AI Agent!</p>
        <hr class="my-4">
        <p>Interact with the AI Agent below.</p>
        <ul class="list-items">
            <li>
                <form method="POST" action="{% url 'agt:reset_timeline' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">リセット</button>
                </form>
            </li>
            <li>
                <form method="POST" action="{% url 'agt:next_turn' %}" style="display: inline;">
                    {% csrf_token %}
                    {% if user.is_superuser %}
                        <button type="submit" class="btn btn-primary">1単位時間進める</button>
                    {% else %}
                        <button type="submit" class="btn btn-outline-secondary" disabled>1単位時間進める</button>
                    {% endif %}
                </form>
            </li>
        </ul>
        {% if not user.is_superuser %}
            <div class="mt-3 text-secondary">「1単位時間進める」ボタンは管理者権限が必要です</div>
        {% endif %}
    </div>
    <div class="container">
        <section id="content-section" class="d-flex flex-column">
            <div class="d-flex flex-grow-1">
                <!-- タイムラインディスプレイ (左側コンテンツ) -->
                <div class="timeline-display flex-grow-1">
                    <div class="container mt-4">
                        <h2>AI Agent Simulation</h2>
                        {% if messages %}
                            <div class="system-messages mb-4 p-3 border rounded bg-light">
                                <h5 class="mb-3"><i class="bi bi-info-circle"></i> システム通知</h5>
                                <ul class="list-unstyled mb-0">
                                    {% for message in messages %}
                                        <li class="mb-2">{{ message }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        <div class="chat-history mb-4">
                            <h5 class="mb-3"><i class="bi bi-chat-dots"></i> チャット履歴</h5>
                            {% for chat_message in chat_messages %}
                                {% if '[ERROR]' in chat_message.message_content %}
                                    <div class="alert alert-danger" role="alert">
                                        {{ chat_message.message_content }}
                                    </div>
                                {% else %}
                                    <div class="alert alert-light border" role="alert">
                                        {{ chat_message.message_content }}
                                    </div>
                                {% endif %}
                            {% empty %}
                                <div class="alert alert-warning" role="alert">
                                    メッセージ履歴がありません。
                                </div>
                            {% endfor %}
                        </div>

                        {% with next_entity=future_actions.first.entity %}
                            <form method="POST" action="{% url 'agt:index' %}">
                                {% csrf_token %}
                                {{ form.as_p }}
                                <button type="submit" class="btn btn-primary mt-2"
                                        {% if next_entity.name != 'User' %}disabled{% endif %}>Send
                                </button>
                            </form>
                        {% endwith %}
                    </div>
                </div>

                <!-- タイムライン情報 (右側サイドバー) -->
                <div class="timeline-info p-3 bg-light border">
                    <h4>現在のターン</h4>
                    <p>
                        {% with latest_completed_turn|default:0 as current_turn %}
                            現在のターン: {{ current_turn }}
                        {% endwith %}
                    </p>

                    <h4>予定される順番</h4>
                    <ul>
                        {% for future_action in future_actions %}
                            <li>{{ future_action.entity.name }} (次の行動予定: {{ future_action.acted_at_turn }})</li>
                        {% empty %}
                            <p>（なし）</p>
                        {% endfor %}
                    </ul>

                    <h4>終了したターンのログ</h4>
                    <ul>
                        {% for completed_action in completed_actions %}
                            <li>{{ completed_action.entity.name }} (完了済み: {{ completed_action.acted_at_turn }})</li>
                        {% empty %}
                            <p>（なし）</p>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </section>
    </div>
{% endblock %}
