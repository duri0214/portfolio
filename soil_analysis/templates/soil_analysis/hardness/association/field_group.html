{% extends "soil_analysis/base.html" %}
{% load static %}
{% block content %}
    <div class="container">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'soil:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'soil:hardness_upload' %}">Upload hardness</a></li>
                <li class="breadcrumb-item"><a href="{% url 'soil:hardness_association' %}">Association</a></li>
                <li class="breadcrumb-item active" aria-current="page">Field Group</li>
            </ol>
        </nav>

        <h1>圃場グループの帳簿選択</h1>

        <!-- 進捗情報 -->
        <div class="alert alert-info mb-4">
            <div class="row">
                <div class="col-md-8">
                    <h6><i class="fas fa-folder"></i> 処理対象フォルダ: {{ folder_name }}</h6>
                    <p class="mb-0">
                        フォルダ「{{ folder_name }}」の全データ（メモリー{{ min_memory }}番〜{{ max_memory }}番、{{ object_list|length }}レコード）を処理します</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-primary fs-6">{{ processed_groups }}/{{ total_groups }} 完了</span>
                </div>
            </div>
        </div>

        <!-- データプレビュー -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-table"></i> 処理対象データ</h6>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>Memory</th>
                        <th>DateTime</th>
                        <th>Depth</th>
                        <th>Folder</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for measurement in object_list|slice:":5" %}
                        <tr>
                            <td>{{ measurement.set_memory }}</td>
                            <td>{{ measurement.set_datetime|date:"Y-m-d H:i" }}</td>
                            <td>{{ measurement.depth }}cm</td>
                            <td>{{ measurement.folder }}</td>
                        </tr>
                    {% endfor %}
                    {% if object_list|length > 5 %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                <i class="fas fa-ellipsis-h"></i> 他 {{ object_list|length|add:"-5" }} レコード
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>

                <!-- データ統計情報 -->
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">{{ object_list|length }}</h5>
                                    <p class="card-text small mb-0">総レコード数</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-info">{{ memory_anchor }}</h5>
                                    <p class="card-text small mb-0">開始メモリー</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">{{ folder_name }}</h5>
                                    <p class="card-text small mb-0">フォルダ名</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 帳簿選択フォーム -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-book"></i> 帳簿選択</h6>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="land_ledger" class="form-label mb-0">関連付ける帳簿を選択してください</label>
                            <!-- TODO: 帳簿マスタ新規登録機能 -->
                            <!-- 
                            新機能実装予定：
                            - CSVデータ取り込み直後には対応する帳簿（LandLedger）が存在しない場合が多い
                            - このページから直接新規帳簿を作成できる機能を追加する
                            - 必要なフィールド：
                              * sampling_date (採土日)
                              * land (圃場) - フォルダ名から推定
                              * crop (作物)
                              * land_period (時期)
                              * sampling_method (採土法) - デフォルト5点法
                              * analytical_agency (分析機関)
                              * sampling_staff (採土者)
                            -->
                            <button type="button" class="btn btn-outline-success btn-sm" id="btn_create_ledger"
                                    disabled>
                                <i class="fas fa-plus"></i> 新規帳簿作成 (未実装)
                            </button>
                        </div>
                        <select class="form-select" name="land_ledger" id="land_ledger" required>
                            <option selected disabled value="">帳簿を選択</option>
                            {% for land_ledger in land_ledgers %}
                                <option value="{{ land_ledger.pk }}">
                                    {{ land_ledger.land.company.name }} -
                                    {{ land_ledger.land.name }}
                                    ({{ land_ledger.land_period.year }} {{ land_ledger.land_period.name }})
                                </option>
                            {% endfor %}
                        </select>
                        {% if folder_name %}
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i>
                                フォルダ名「{{ folder_name }}」に適した帳簿が優先表示されています
                            </div>
                        {% endif %}
                        {% if not land_ledgers %}
                            <div class="alert alert-warning mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                このフォルダに適した帳簿が見つかりません。新規帳簿作成機能の実装をお待ちください。
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'soil:hardness_association' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 戻る
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> この帳簿で処理実行
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="alert alert-warning mt-4">
            <h6><i class="fas fa-exclamation-triangle"></i> 注意事項</h6>
            <ul class="mb-0">
                <li>一度処理を実行すると変更できません</li>
                <li>圃場と帳簿の所有者が一致していることを確認してください</li>
                <li>処理完了後、硬度データの関連付け画面に戻ります</li>
            </ul>
        </div>
    </div>
{% endblock %}
