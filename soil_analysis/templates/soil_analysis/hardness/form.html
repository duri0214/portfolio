{% extends "soil_analysis/base.html" %}
{% load static %}
{% block content %}
    <div class="container">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'soil:home' %}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Upload hardness</li>
            </ol>
        </nav>
        <h1>土壌硬度データのアップロード</h1>

        <!-- オペレーションマニュアル -->
        <div class="alert alert-primary" role="alert">
            <h5><i class="bi bi-journal-bookmark"></i> 操作手順ガイド</h5>
            <p class="mb-3">硬度データの処理は以下の順序で進めてください：</p>

            <div class="card border-light mb-2">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-3">1</span>
                        <div>
                            <strong>データアップロード</strong>
                            <br><small class="text-muted">ZIPファイルをアップロードして処理完了を待つ</small>
                            <br><small class="text-muted">※補足：テスト用CSV生成、全データ削除機能も下記にあります</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-light mb-2">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-3">2</span>
                        <div>
                            <strong>アップロードデータ確認</strong>
                            <br><small class="text-muted">取り込みデータ数を確認し、必要に応じて不足している圃場の新規登録を行う</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-light mb-2">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-3">3</span>
                        <div>
                            <strong>硬度データの関連付け</strong>
                            <br><small class="text-muted">各圃場グループごとに適切な帳簿を選択・関連付け（必要に応じて新規帳簿作成）</small>
                            <br><small class="text-muted">※すべてのグループの処理完了まで次のステップに進めません</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-light mb-2">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-3">4</span>
                        <div>
                            <strong>関連付けデータ確認</strong>
                            <br><small class="text-muted">関連付けデータ集計（フォルダ別・Block別・Ledger別）を確認</small>
                            <br><small class="text-muted">必要に応じて「3Dプロット画像を生成して圃場に紐づける」ボタンを押下</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-light mb-2">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-3">5</span>
                        <div>
                            <strong>グラフ確認</strong>
                            <br><small class="text-muted"><a href="{% url 'soil:company_list' %}">圃場一覧画面</a>で生成された3Dプロット画像を確認</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 既存のアップロード機能 -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h3>CSVファイルアップロード</h3>
                <p class="text-muted">取り込みCSV フォルダをzip化してアップロードしてください</p>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-upload"></i> アップロード
                    </button>
                </form>
            </div>
        </div>

        <hr>

        <!-- 開発・テスト用機能 -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-success">
                            <i class="bi bi-file-earmark-plus"></i> テスト用CSV生成
                        </h5>
                        <p class="card-text text-muted">
                            開発・テスト用のサンプルCSVデータを生成してダウンロードできます。
                            <br><small>※指定した圃場数分のテストデータが生成されます</small>
                        </p>
                        <form method="post" action="{% url 'soil:hardness_generate_dummy_csv' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ csv_generate_form.num_fields.label_tag }}
                                {{ csv_generate_form.num_fields }}
                                {% if csv_generate_form.num_fields.help_text %}
                                    <div class="form-text">{{ csv_generate_form.num_fields.help_text }}</div>
                                {% endif %}
                                {% if csv_generate_form.num_fields.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in csv_generate_form.num_fields.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-download"></i> テスト用CSV生成・ダウンロード
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card border-danger">
                    <div class="card-body">
                        <h5 class="card-title text-danger">
                            <i class="bi bi-trash"></i> 全データ削除
                        </h5>
                        <p class="card-text text-muted">
                            SoilHardnessMeasurementテーブルの全レコードを削除します。
                            <br><small class="text-danger">※この操作は取り消すことができません</small>
                        </p>
                        <button type="button" class="btn btn-danger" onclick="confirmDeleteAll()">
                            <i class="bi bi-exclamation-triangle"></i> 全データ削除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> 全消し注意
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <strong>警告:</strong> この操作により、SoilHardnessMeasurementテーブルの全データが完全に削除されます。
                    </div>
                    <p>この操作は取り消すことができません。本当に実行しますか？</p>
                    <p class="text-muted">削除を実行する場合は「削除実行」ボタンをクリックしてください。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <form method="post" action="{% url 'soil:hardness_delete_all' %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> 削除実行
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDeleteAll() {
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        }
    </script>
{% endblock %}
