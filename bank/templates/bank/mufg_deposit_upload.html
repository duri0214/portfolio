{% extends "bank/base.html" %}
{% load static %}
{% block content %}
    <div class="container">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'bank:index' %}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">MUFG普通預金 CSVアップロード</li>
            </ol>
        </nav>
        <h1>MUFG普通預金CSV（Eco通帳）のアップロード</h1>

        <div class="alert alert-primary" role="alert">
            <h5><i class="bi bi-info-circle"></i> アップロード方法</h5>
            <p>以下のいずれかの形式でアップロードしてください。</p>
            <ul>
                <li><strong>CSVファイル:</strong> MUFG公式のEco通帳からダウンロードしたファイルをそのまま1つアップロード。</li>
                <li><strong>ZIPファイル:</strong> 複数のCSVファイルを1つのZIPにまとめてアップロード。
                    <ul>
                        <li>ZIPの直下、またはフォルダ内にCSVファイルを配置してください。</li>
                        <li>拡張子が <code>.csv</code> のファイルのみが処理対象となります。</li>
                        <li><strong>※ZIP内のすべてのファイルが、選択した「対象口座」に保存されます。</strong></li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <h3>ファイル アップロード</h3>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form.bank.id_for_label }}" class="form-label">{{ form.bank.label }}</label>
                        <div class="input-group">
                            {{ form.bank }}
                            <button class="btn btn-outline-danger" type="button" id="deleteDataBtn">
                                <i class="bi bi-trash"></i> データ削除
                            </button>
                        </div>
                        {% if form.bank.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.bank.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.file.id_for_label }}" class="form-label">{{ form.file.label }}</label>
                        {{ form.file }}
                        {% if form.file.help_text %}
                            <div class="form-text">{{ form.file.help_text }}</div>
                        {% endif %}
                        {% if form.file.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.file.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-upload"></i> アップロード
                    </button>
                </form>
            </div>
        </div>

        {% if messages %}
            <div class="messages mt-4">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message|safe }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- 削除用フォーム -->
    <form id="deleteForm" method="post" action="{% url 'bank:mufg_deposit_delete' %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="bank" id="deleteBankId">
    </form>

    <script>
        document.getElementById('deleteDataBtn').addEventListener('click', function() {
            const bankSelect = document.getElementById('id_bank');
            const bankId = bankSelect.value;
            const bankName = bankSelect.options[bankSelect.selectedIndex].text;

            if (!bankId) {
                alert('削除対象の口座を選択してください。');
                return;
            }

            if (confirm(`${bankName} の全データを削除してもよろしいですか？\n※この操作は取り消せません。`)) {
                document.getElementById('deleteBankId').value = bankId;
                document.getElementById('deleteForm').submit();
            }
        });
    </script>
{% endblock %}
